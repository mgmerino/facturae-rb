#!/usr/bin/env ruby
# frozen_string_literal: true

# Script to generate a signed Facturae XML fixture for validation testing
# Usage: bundle exec ruby bin/generate_signed_fixture

require "bundler/setup"
require "facturae"
require "openssl"

# Create seller party
seller_party = Facturae::Party.new(
  person_type_code: "J",
  residence_type_code: "R",
  tax_id_number: "B12345678",
  subject: Facturae::Subject.new(
    type: :legal,
    name_field1: "Test Company SL",
    name_field2: "Test Company",
    address_in_spain: Facturae::Address.new(
      address: "Calle Mayor, 1",
      post_code: "28001",
      town: "Madrid",
      province: "Madrid",
      country_code: "ESP"
    )
  )
)

# Create buyer party
buyer_party = Facturae::Party.new(
  person_type_code: "F",
  residence_type_code: "R",
  tax_id_number: "12345678A",
  subject: Facturae::Subject.new(
    type: :individual,
    name_field1: "Juan",
    name_field2: "Garcia",
    name_field3: "Lopez",
    address_in_spain: Facturae::Address.new(
      address: "Calle Menor, 2",
      post_code: "28002",
      town: "Madrid",
      province: "Madrid",
      country_code: "ESP"
    )
  )
)

# Create file header
file_header = Facturae::FileHeader.new(
  modality: "I",
  invoice_issuer_type: "EM",
  batch: {
    invoices_count: 1,
    series_invoice_number: "2025/001",
    total_invoice_amount: 121.0,
    total_tax_outputs: 21.0,
    total_tax_inputs: 0.0,
    invoice_currency_code: "EUR"
  }
)

# Create invoice
invoice = Facturae::Invoice.new(
  invoice_header: {
    invoice_number: "001",
    invoice_series_code: "2025",
    invoice_document_type: "FC",
    invoice_class: "OO"
  },
  issue_data: {
    issue_date: Date.new(2025, 1, 15),
    invoice_currency_code: "EUR",
    tax_currency_code: "EUR",
    language_name: "es"
  }
)

invoice.add_invoice_line(
  Facturae::Line.new(
    item_description: "Professional services",
    quantity: 1.0,
    unit_price_without_tax: 100.0,
    total_cost: 100.0
  )
)

invoice.add_tax_output(
  Facturae::Tax.new(
    tax_type_code: "01",
    tax_rate: 21.0,
    taxable_base: 100.0,
    tax_amount: 21.0
  )
)

invoice.totals = {
  total_gross_amount: 100.0,
  total_taxes_outputs: 21.0,
  total_taxes_withheld: 0.0,
  invoice_total: 121.0,
  total_outstanding_amount: 121.0,
  total_executable_amount: 121.0
}

# Build document
document = Facturae::FacturaeDocument.new(
  file_header: file_header,
  seller_party: seller_party,
  buyer_party: buyer_party
)
document.add_invoice(invoice)

# Generate XML
xml = Facturae::FacturaeBuilder.new(document).to_xml
xml_doc = Nokogiri::XML(xml)

# Load certificate and private key
private_key = OpenSSL::PKey::RSA.new(File.read("spec/fixtures/private_key.pem"))
certificate = OpenSSL::X509::Certificate.new(File.read("spec/fixtures/certificate.pem"))

# Sign the document
signer = Facturae::Xades::Signer.new(xml_doc, private_key, certificate)
signer.sign

# Output to fixture file
output_path = "spec/fixtures/signed_invoice.xml"
File.write(output_path, xml_doc.to_xml)

puts "Signed invoice generated: #{output_path}"
puts "File size: #{File.size(output_path)} bytes"
